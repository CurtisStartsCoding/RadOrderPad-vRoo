openapi: 3.1.0
info:
  title: RadOrderPad API - Validation Engine Focus
  description: |
    API for the RadOrderPad application, with a focus on the validation engine that processes
    clinical indications from physician dictation to assign appropriate CPT and ICD-10 codes.
  version: 1.0.0
  contact:
    name: RadOrderPad Support
    email: support@radorderpad.com

servers:
  - url: /api
    description: Base API path

components:
  securitySchemes:
    jwtBearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from login or registration

  schemas:
    # Patient and validation schemas
    PatientInfo:
      type: object
      required:
        - firstName
        - lastName
        - dateOfBirth
        - gender
      properties:
        id:
          type: integer
          format: int64
        firstName:
          type: string
        lastName:
          type: string
        dateOfBirth:
          type: string
          format: date
        gender:
          type: string
        mrn:
          type: string
        pidn:
          type: string
          description: Patient Identifier Number (e.g., P12345, P-98765, P00123)

    OrderValidationRequest:
      type: object
      required:
        - dictationText
      properties:
        dictationText:
          type: string
          description: The clinical dictation text from the physician
        patientInfo:
          $ref: '#/components/schemas/PatientInfo'
        orderId:
          type: integer
          format: int64
          description: Present on attempts after the first
        isOverrideValidation:
          type: boolean
          description: Set to true for override validation
        radiologyOrganizationId:
          type: integer
          format: int64

    ValidationResult:
      type: object
      properties:
        validationStatus:
          type: string
          enum: [appropriate, inappropriate, needs_clarification, override]
        complianceScore:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Numerical score reflecting appropriateness (0-1)
        feedback:
          type: string
          description: Textual explanation and educational content
        suggestedICD10Codes:
          type: array
          items:
            type: object
            properties:
              code:
                type: string
              description:
                type: string
              confidence:
                type: number
                format: float
        suggestedCPTCodes:
          type: array
          items:
            type: object
            properties:
              code:
                type: string
              description:
                type: string
              confidence:
                type: number
                format: float
        internalReasoning:
          type: string
          description: Internal reasoning for the validation result (may not be present in all responses)

    ValidationResponse:
      type: object
      properties:
        success:
          type: boolean
        orderId:
          type: integer
          format: int64
        validationResult:
          $ref: '#/components/schemas/ValidationResult'

    # Order finalization schemas
    OrderFinalizationRequest:
      type: object
      required:
        - finalValidationStatus
        - finalComplianceScore
        - finalICD10Codes
        - finalICD10CodeDescriptions
        - finalCPTCode
        - finalCPTCodeDescription
        - clinicalIndication
      properties:
        finalValidationStatus:
          type: string
          enum: [appropriate, inappropriate, needs_clarification, override]
        finalComplianceScore:
          type: number
          format: float
        finalICD10Codes:
          type: string
        finalICD10CodeDescriptions:
          type: string
        finalCPTCode:
          type: string
        finalCPTCodeDescription:
          type: string
        clinicalIndication:
          type: string
        isTemporaryPatient:
          type: boolean
        patientInfo:
          $ref: '#/components/schemas/PatientInfo'
        overridden:
          type: boolean
        overrideJustification:
          type: string
        isUrgentOverride:
          type: boolean
        signatureData:
          type: string

    OrderFinalizationResponse:
      type: object
      properties:
        success:
          type: boolean
        orderId:
          type: integer
          format: int64
        message:
          type: string

    # Error response
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        code:
          type: string
        status:
          type: integer
          format: int32

paths:
  # Order validation endpoint
  /orders/validate:
    post:
      tags:
        - Validation Engine
      summary: Validate an order
      description: |
        Validates a radiology order based on dictation text. This is the core endpoint for the validation engine,
        which processes clinical indications from physician dictation to assign appropriate CPT and ICD-10 codes.
        
        The validation process includes:
        1. Extracting medical context from the dictation
        2. Analyzing the clinical indications
        3. Determining appropriate CPT and ICD-10 codes
        4. Assessing compliance with clinical guidelines
        5. Providing educational feedback
        
        Processing takes approximately 11-15 seconds per request.
      operationId: validateOrder
      security:
        - jwtBearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderValidationRequest'
            examples:
              initialValidation:
                summary: Initial validation request
                value:
                  dictationText: "72-year-old male with persistent lower back pain radiating to the left leg for 3 weeks. History of degenerative disc disease. Clinical concern for lumbar radiculopathy."
                  patientInfo:
                    firstName: "Robert"
                    lastName: "Johnson"
                    dateOfBirth: "1950-05-15"
                    gender: "male"
                    pidn: "P12345"
              subsequentAttempt:
                summary: Subsequent validation attempt
                value:
                  dictationText: "72-year-old male with persistent lower back pain radiating to the left leg for 3 weeks. History of degenerative disc disease. Clinical concern for lumbar radiculopathy.\n\n--- CLARIFICATION 1 ---\nPain is worse with standing and walking. Physical exam shows positive straight leg raise on left side. No bowel or bladder symptoms."
                  patientInfo:
                    firstName: "Robert"
                    lastName: "Johnson"
                    dateOfBirth: "1950-05-15"
                    gender: "male"
                    pidn: "P12345"
                  orderId: 123
              overrideValidation:
                summary: Override validation request
                value:
                  dictationText: "72-year-old male with persistent lower back pain radiating to the left leg for 3 weeks. History of degenerative disc disease. Clinical concern for lumbar radiculopathy.\n\n--- CLARIFICATION 1 ---\nPain is worse with standing and walking. Physical exam shows positive straight leg raise on left side. No bowel or bladder symptoms.\n\n--- OVERRIDE JUSTIFICATION ---\nPatient has failed conservative therapy including physical therapy and NSAIDs. MRI is needed to evaluate for possible surgical intervention."
                  patientInfo:
                    firstName: "Robert"
                    lastName: "Johnson"
                    dateOfBirth: "1950-05-15"
                    gender: "male"
                    pidn: "P12345"
                  orderId: 123
                  isOverrideValidation: true
      responses:
        '200':
          description: Validation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResponse'
              examples:
                appropriateResponse:
                  summary: Appropriate validation response
                  value:
                    success: true
                    orderId: 123
                    validationResult:
                      validationStatus: "appropriate"
                      complianceScore: 0.95
                      feedback: "MRI lumbar spine without contrast is appropriate for evaluating lower back pain with radicular symptoms, especially with history of degenerative disc disease. Clinical presentation suggests lumbar radiculopathy which warrants imaging evaluation."
                      suggestedCPTCodes:
                        - code: "72148"
                          description: "Magnetic resonance (eg, proton) imaging, spinal canal and contents, lumbar; without contrast material"
                          confidence: 0.95
                        - code: "72083"
                          description: "X-ray spine, entire thoracic and lumbar"
                          confidence: 0.75
                      suggestedICD10Codes:
                        - code: "M54.17"
                          description: "Radiculopathy, lumbosacral region"
                          confidence: 0.9
                        - code: "M51.36"
                          description: "Other intervertebral disc degeneration, lumbar region"
                          confidence: 0.85
                        - code: "M54.5"
                          description: "Low back pain"
                          confidence: 0.8
                needsClarificationResponse:
                  summary: Needs clarification response
                  value:
                    success: true
                    orderId: 123
                    validationResult:
                      validationStatus: "needs_clarification"
                      complianceScore: 0.6
                      feedback: "Additional information is needed to determine appropriateness. Please provide: 1) Duration of symptoms, 2) Any prior treatments attempted, 3) Any neurological symptoms such as weakness or numbness, 4) Results of physical examination."
                      suggestedCPTCodes:
                        - code: "72148"
                          description: "Magnetic resonance (eg, proton) imaging, spinal canal and contents, lumbar; without contrast material"
                          confidence: 0.7
                      suggestedICD10Codes:
                        - code: "M54.5"
                          description: "Low back pain"
                          confidence: 0.8
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Validation service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Order finalization endpoint
  /orders/{orderId}:
    put:
      tags:
        - Validation Engine
      summary: Finalize an order
      description: |
        Finalizes a radiology order with validation results and signature.
        This endpoint is used after the validation process is complete to save the final
        CPT and ICD-10 codes, clinical indication, and physician signature.
      operationId: finalizeOrder
      security:
        - jwtBearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: ID of the order to finalize
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderFinalizationRequest'
            example:
              finalValidationStatus: "appropriate"
              finalComplianceScore: 0.95
              finalICD10Codes: "M54.17,M51.36"
              finalICD10CodeDescriptions: "Radiculopathy, lumbosacral region;Other intervertebral disc degeneration, lumbar region"
              finalCPTCode: "72148"
              finalCPTCodeDescription: "Magnetic resonance (eg, proton) imaging, spinal canal and contents, lumbar; without contrast material"
              clinicalIndication: "72-year-old male with persistent lower back pain radiating to the left leg for 3 weeks. History of degenerative disc disease. Clinical concern for lumbar radiculopathy."
              overridden: false
              signatureData: "data:image/png;base64,..."
      responses:
        '200':
          description: Order finalized successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderFinalizationResponse'
              example:
                success: true
                orderId: 123
                message: "Order submitted successfully."
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'