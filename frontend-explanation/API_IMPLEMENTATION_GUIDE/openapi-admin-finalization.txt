openapi: 3.1.0
info:
  title: RadOrderPad API - Admin Finalization Focus
  description: |
    API for the RadOrderPad application, with a focus on the admin finalization workflow
    that allows administrative staff to add EMR context and send orders to radiology
    after they've been signed by physicians.
  version: 1.0.0
  contact:
    name: RadOrderPad Support
    email: support@radorderpad.com

servers:
  - url: /api
    description: Base API path

components:
  securitySchemes:
    jwtBearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from login or registration

  schemas:
    # Patient and order schemas
    PatientInfo:
      type: object
      required:
        - firstName
        - lastName
        - dateOfBirth
        - gender
      properties:
        id:
          type: integer
          format: int64
        firstName:
          type: string
        lastName:
          type: string
        dateOfBirth:
          type: string
          format: date
        gender:
          type: string
        mrn:
          type: string
        pidn:
          type: string
          description: Patient Identifier Number (e.g., P12345, P-98765, P00123)
        address_line1:
          type: string
        address_line2:
          type: string
        city:
          type: string
        state:
          type: string
        zip_code:
          type: string
        phone_number:
          type: string
        email:
          type: string
          format: email

    InsuranceInfo:
      type: object
      properties:
        insurance_provider:
          type: string
        insurance_id:
          type: string
        group_number:
          type: string
        policy_holder_name:
          type: string
        policy_holder_relationship:
          type: string
          enum: [self, spouse, child, other]
        policy_holder_dob:
          type: string
          format: date

    OrderSummary:
      type: object
      properties:
        id:
          type: integer
          format: int64
        order_number:
          type: string
        patient_name:
          type: string
        patient_dob:
          type: string
          format: date
        patient_gender:
          type: string
        referring_physician_name:
          type: string
        modality:
          type: string
        body_part:
          type: string
        laterality:
          type: string
        final_cpt_code:
          type: string
        final_cpt_code_description:
          type: string
        final_icd10_codes:
          type: string
        final_icd10_code_descriptions:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AdminOrderQueueResponse:
      type: object
      properties:
        orders:
          type: array
          items:
            $ref: '#/components/schemas/OrderSummary'
        pagination:
          type: object
          properties:
            total:
              type: integer
            page:
              type: integer
            limit:
              type: integer
            pages:
              type: integer

    PatientInfoUpdateRequest:
      type: object
      properties:
        address_line1:
          type: string
        address_line2:
          type: string
        city:
          type: string
        state:
          type: string
        zip_code:
          type: string
        phone_number:
          type: string
        email:
          type: string
          format: email
        mrn:
          type: string
        pidn:
          type: string

    InsuranceInfoUpdateRequest:
      type: object
      properties:
        insurance_provider:
          type: string
        insurance_id:
          type: string
        group_number:
          type: string
        policy_holder_name:
          type: string
        policy_holder_relationship:
          type: string
          enum: [self, spouse, child, other]
        policy_holder_dob:
          type: string
          format: date

    SupplementalDocRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          description: Supplemental documentation text from EMR

    SendToRadiologyResponse:
      type: object
      properties:
        success:
          type: boolean
        orderId:
          type: integer
          format: int64
        message:
          type: string

    InsufficientCreditsError:
      type: object
      properties:
        message:
          type: string
        code:
          type: string
          enum: [INSUFFICIENT_CREDITS]
        orderId:
          type: integer
          format: int64

    # Error response
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        code:
          type: string
        status:
          type: integer
          format: int32

paths:
  # Admin order queue endpoint
  /admin/orders/queue:
    get:
      tags:
        - Admin Finalization
      summary: List orders awaiting admin finalization
      description: |
        Retrieves a list of orders awaiting admin finalization (status = 'pending_admin') 
        for the current user's organization. This is the first step in the admin finalization workflow,
        allowing admin staff to see which orders need to be processed.
      operationId: listOrdersAwaitingAdminFinalization
      security:
        - jwtBearerAuth: []
      parameters:
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: Number of items per page
          schema:
            type: integer
            default: 20
        - name: sortBy
          in: query
          description: Field to sort by
          schema:
            type: string
            default: created_at
        - name: sortOrder
          in: query
          description: Sort direction
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: patientName
          in: query
          description: Filter by patient name
          schema:
            type: string
        - name: physicianName
          in: query
          description: Filter by referring physician name
          schema:
            type: string
        - name: dateFrom
          in: query
          description: Filter by created date from (ISO format)
          schema:
            type: string
            format: date
        - name: dateTo
          in: query
          description: Filter by created date to (ISO format)
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Orders retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminOrderQueueResponse'
              example:
                orders:
                  - id: 612
                    order_number: "ORD-1745331663206"
                    patient_name: "John Smith"
                    patient_dob: "1950-05-15"
                    patient_gender: "male"
                    referring_physician_name: "Dr. Jane Doe"
                    modality: "MRI"
                    body_part: "LUMBAR_SPINE"
                    laterality: null
                    final_cpt_code: "72148"
                    final_cpt_code_description: "MRI lumbar spine without contrast"
                    final_icd10_codes: "{\"M54.16\",\"M51.36\",\"M79.605\"}"
                    final_icd10_code_descriptions: null
                    created_at: "2025-04-22T14:21:03.301Z"
                    updated_at: "2025-04-22T14:21:15.538Z"
                pagination:
                  total: 32
                  page: 1
                  limit: 20
                  pages: 2
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Patient information update endpoint
  /admin/orders/{orderId}/patient-info:
    put:
      tags:
        - Admin Finalization
      summary: Update patient information
      description: |
        Updates patient information for a specific order. This is part of the admin finalization workflow,
        allowing admin staff to add or update patient demographics before sending the order to radiology.
      operationId: updatePatientInfo
      security:
        - jwtBearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: ID of the order to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PatientInfoUpdateRequest'
            example:
              address_line1: "123 Main St"
              address_line2: "Apt 4B"
              city: "Springfield"
              state: "IL"
              zip_code: "62704"
              phone_number: "555-123-4567"
              email: "john.smith@example.com"
              mrn: "MRN12345"
              pidn: "P12345"
      responses:
        '200':
          description: Patient information updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  orderId:
                    type: integer
                    format: int64
              example:
                success: true
                message: "Patient information updated successfully"
                orderId: 612
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Insurance information update endpoint
  /admin/orders/{orderId}/insurance-info:
    put:
      tags:
        - Admin Finalization
      summary: Update insurance information
      description: |
        Updates insurance information for a specific order. This is part of the admin finalization workflow,
        allowing admin staff to add or update insurance details before sending the order to radiology.
      operationId: updateInsuranceInfo
      security:
        - jwtBearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: ID of the order to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InsuranceInfoUpdateRequest'
            example:
              insurance_provider: "Blue Cross Blue Shield"
              insurance_id: "XYZ123456789"
              group_number: "GRP987654"
              policy_holder_name: "John Smith"
              policy_holder_relationship: "self"
              policy_holder_dob: "1950-05-15"
      responses:
        '200':
          description: Insurance information updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  orderId:
                    type: integer
                    format: int64
              example:
                success: true
                message: "Insurance information updated successfully"
                orderId: 612
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Supplemental documentation endpoint
  /admin/orders/{orderId}/paste-supplemental:
    post:
      tags:
        - Admin Finalization
      summary: Add supplemental documentation
      description: |
        Adds supplemental documentation from EMR to a specific order. This is part of the admin finalization workflow,
        allowing admin staff to include additional clinical information before sending the order to radiology.
      operationId: addSupplementalDocs
      security:
        - jwtBearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: ID of the order to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SupplementalDocRequest'
            example:
              text: "Patient has history of lower back pain for 3 weeks. Physical therapy was attempted without improvement. Patient reports pain radiating down left leg. No bowel or bladder symptoms."
      responses:
        '200':
          description: Supplemental documentation added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  orderId:
                    type: integer
                    format: int64
              example:
                success: true
                message: "Supplemental documentation added successfully"
                orderId: 612
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Send to radiology endpoint
  /admin/orders/{orderId}/send-to-radiology-fixed:
    post:
      tags:
        - Admin Finalization
      summary: Send order to radiology
      description: |
        Finalizes an order and sends it to the radiology organization. This is the final step in the admin finalization workflow.
        
        This endpoint uses dual database connections:
        1. PHI Database: Updates order status and adds order history
        2. Main Database: Decrements organization credit balance
        
        The implementation includes proper transaction management across both databases to ensure data consistency.
      operationId: sendToRadiology
      security:
        - jwtBearerAuth: []
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: ID of the order to send to radiology
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
            example: {}
      responses:
        '200':
          description: Order sent to radiology successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendToRadiologyResponse'
              example:
                success: true
                orderId: 612
                message: "Order sent to radiology successfully"
        '400':
          description: Invalid request or incomplete patient information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "Patient information is incomplete. City, state, and zip code are required."
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '402':
          description: Insufficient credits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InsufficientCreditsError'
              example:
                message: "Insufficient credits to send order to radiology"
                code: "INSUFFICIENT_CREDITS"
                orderId: 612
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                message: "Order 612 not found"
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'