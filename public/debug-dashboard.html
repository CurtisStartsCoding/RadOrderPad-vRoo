<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadOrderPad Debug Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background: #f1f3f5;
        }
        .query-section {
            margin-top: 20px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }
        .auth-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>RadOrderPad Debug Dashboard</h1>
        <p>Troubleshooting interface for super admins. All operations are read-only.</p>
    </div>

    <div class="auth-section">
        <h3>Authentication</h3>
        <input type="text" id="authToken" placeholder="Enter your JWT token (Bearer token)" />
        <button onclick="saveToken()">Save Token</button>
        <button onclick="clearToken()">Clear Token</button>
        <div id="authStatus"></div>
    </div>

    <div class="section">
        <h2>Quick Lookups</h2>
        <div class="button-group">
            <button onclick="fetchData('organizations')">List All Organizations</button>
            <button onclick="fetchData('users')">List All Users</button>
            <button onclick="fetchData('orders')">Recent Orders (50)</button>
            <button onclick="fetchData('connections')">Organization Connections</button>
            <button onclick="fetchData('trial-users/stats')" style="background: #28a745;">Trial User Statistics</button>
        </div>

        <div class="section">
            <h3>Order Lookups</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="orderId" placeholder="Order ID" style="width: 150px;" />
                <button onclick="fetchOrderDetails()">Get Clinical Records</button>
                <button onclick="fetchCompleteOrderDetails()" style="background: #17a2b8;">Get Complete Details</button>
                <button onclick="fetchOrderUpdateHistory()">Update History</button>
                
                <input type="text" id="orderNumber" placeholder="Order Number (ORD-xxx)" style="width: 250px;" />
                <button onclick="fetchOrderByNumber()">Find Order</button>
            </div>
        </div>

        <div class="section">
            <h3>Physician Lookups</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <input type="text" id="physicianId" placeholder="Physician User ID" style="width: 150px;" />
                <button onclick="fetchPhysicianOrders()">Get Physician Orders</button>
                <button onclick="fetchOrdersByPhysician()">Search Orders by Physician</button>
            </div>
        </div>

        <div class="section">
            <h3>Patient Details</h3>
            <input type="text" id="patientId" placeholder="Enter Patient ID" style="width: 200px; margin-right: 10px;" />
            <button onclick="fetchPatientInsurance()">Get Insurance Records</button>
        </div>

        <div class="section">
            <h3>Trial User Details</h3>
            <input type="text" id="trialUserId" placeholder="Enter Trial User ID" style="width: 200px; margin-right: 10px;" />
            <button onclick="fetchTrialUserActivity()">Get Activity Details</button>
        </div>

        <div class="section">
            <h3>Organization Connections</h3>
            <input type="text" id="orgConnectionId" placeholder="Enter Organization ID" style="width: 200px; margin-right: 10px;" />
            <button onclick="fetchOrganizationConnections()">Get Connections & Locations</button>
        </div>
    </div>

    <div class="section query-section">
        <h2>Custom Query</h2>
        <p>Execute SELECT queries only. Other operations are blocked for safety.</p>
        <select id="database" style="margin-bottom: 10px;">
            <option value="main">Main Database (Non-PHI)</option>
            <option value="phi">PHI Database</option>
        </select>
        <textarea id="customQuery" rows="4" placeholder="SELECT * FROM organizations WHERE type = 'radiology_group'"></textarea>
        <button onclick="executeQuery()">Execute Query</button>
    </div>

    <div class="section">
        <h2>Results</h2>
        <div id="results" class="results">
            <p class="info">Click a button above to fetch data</p>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api/debug';
        
        // Load token from localStorage on page load
        window.onload = function() {
            const savedToken = localStorage.getItem('debugToken');
            if (savedToken) {
                document.getElementById('authToken').value = savedToken;
                document.getElementById('authStatus').innerHTML = '<span class="success">Token loaded from storage</span>';
            }
        };

        function saveToken() {
            const token = document.getElementById('authToken').value.trim();
            if (token) {
                localStorage.setItem('debugToken', token);
                document.getElementById('authStatus').innerHTML = '<span class="success">Token saved</span>';
            } else {
                document.getElementById('authStatus').innerHTML = '<span class="error">Please enter a token</span>';
            }
        }

        function clearToken() {
            localStorage.removeItem('debugToken');
            document.getElementById('authToken').value = '';
            document.getElementById('authStatus').innerHTML = '<span class="info">Token cleared</span>';
        }

        function getAuthHeaders() {
            const token = document.getElementById('authToken').value.trim() || localStorage.getItem('debugToken');
            if (!token) {
                throw new Error('No authentication token provided');
            }
            return {
                'Authorization': token.startsWith('Bearer ') ? token : `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        async function fetchData(endpoint) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="loading">Loading...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/${endpoint}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayResults(data, endpoint);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function fetchOrderDetails() {
            const orderId = document.getElementById('orderId').value.trim();
            if (!orderId) {
                alert('Please enter an Order ID');
                return;
            }
            fetchData(`orders/${orderId}/clinical-records`);
        }

        async function fetchOrderByNumber() {
            const orderNumber = document.getElementById('orderNumber').value.trim();
            if (!orderNumber) {
                alert('Please enter an Order Number');
                return;
            }
            fetchData(`orders?orderNumber=${encodeURIComponent(orderNumber)}`);
        }

        async function fetchPhysicianOrders() {
            const physicianId = document.getElementById('physicianId').value.trim();
            if (!physicianId) {
                alert('Please enter a Physician ID');
                return;
            }
            fetchData(`physicians/${physicianId}/orders`);
        }

        async function fetchOrdersByPhysician() {
            const physicianId = document.getElementById('physicianId').value.trim();
            if (!physicianId) {
                alert('Please enter a Physician ID');
                return;
            }
            fetchData(`orders?physicianId=${physicianId}`);
        }

        async function fetchPatientInsurance() {
            const patientId = document.getElementById('patientId').value.trim();
            if (!patientId) {
                alert('Please enter a Patient ID');
                return;
            }
            fetchData(`patients/${patientId}/insurance`);
        }

        async function fetchTrialUserActivity() {
            const trialUserId = document.getElementById('trialUserId').value.trim();
            if (!trialUserId) {
                alert('Please enter a Trial User ID');
                return;
            }
            fetchData(`trial-users/${trialUserId}/activity`);
        }

        async function fetchCompleteOrderDetails() {
            const orderId = document.getElementById('orderId').value.trim();
            if (!orderId) {
                alert('Please enter an Order ID');
                return;
            }
            fetchData(`orders/${orderId}/complete`);
        }

        async function fetchOrderUpdateHistory() {
            const orderId = document.getElementById('orderId').value.trim();
            if (!orderId) {
                alert('Please enter an Order ID');
                return;
            }
            fetchData(`orders/${orderId}/update-history`);
        }

        async function fetchOrganizationConnections() {
            const orgId = document.getElementById('orgConnectionId').value.trim();
            if (!orgId) {
                alert('Please enter an Organization ID');
                return;
            }
            fetchData(`organizations/${orgId}/connections`);
        }

        async function executeQuery() {
            const query = document.getElementById('customQuery').value.trim();
            const database = document.getElementById('database').value;
            
            if (!query) {
                alert('Please enter a query');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="loading">Executing query...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ query, database })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayResults(data, 'Custom Query');
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displayResults(data, title) {
            const resultsDiv = document.getElementById('results');
            
            if (!data.success) {
                resultsDiv.innerHTML = `<div class="error">Error: ${data.error || 'Unknown error'}</div>`;
                return;
            }
            
            // Special handling for trial user statistics
            if (title === 'trial-users/stats') {
                displayTrialUserStats(data);
                return;
            }
            
            // Special handling for physician orders
            if (data.physician && data.statistics) {
                displayPhysicianStats(data);
                return;
            }
            
            // Special handling for trial user activity
            if (data.user && data.recentValidations) {
                displayTrialUserActivity(data);
                return;
            }
            
            // Special handling for complete order details
            if (data.order && data.patient !== undefined) {
                displayCompleteOrderDetails(data);
                return;
            }
            
            // Special handling for organization connections
            if (data.connections && data.organizationId) {
                displayOrganizationConnections(data);
                return;
            }
            
            // Special handling for update history
            if (data.updateHistory) {
                displayUpdateHistory(data);
                return;
            }
            
            if (!data.data || data.data.length === 0) {
                resultsDiv.innerHTML = `<div class="info">No results found for ${title}</div>`;
                return;
            }
            
            // Build table
            const headers = Object.keys(data.data[0]);
            let html = `
                <h3>${title} (${data.count || data.data.length} results)</h3>
                <table>
                    <thead>
                        <tr>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    let value = row[header];
                    if (value === null) {
                        value = '<i>null</i>';
                    } else if (typeof value === 'object') {
                        value = JSON.stringify(value);
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }

        function displayTrialUserStats(data) {
            const resultsDiv = document.getElementById('results');
            let html = '<h3>Trial User Statistics</h3>';
            
            // Summary section
            html += '<div class="info">';
            html += '<h4>Summary</h4>';
            const summary = data.summary;
            html += `<p>Total Trial Users: <strong>${summary.total_trial_users}</strong></p>`;
            html += `<p>Active Users (have validated): <strong>${summary.active_users}</strong></p>`;
            html += `<p>Users at Max Limit: <strong>${summary.maxed_out_users}</strong></p>`;
            html += `<p>Total Validations: <strong>${summary.total_validations}</strong></p>`;
            html += `<p>Average Validations per User: <strong>${parseFloat(summary.avg_validations_per_user).toFixed(1)}</strong></p>`;
            html += `<p>Most Active User Validations: <strong>${summary.max_validations_by_user}</strong></p>`;
            html += '</div>';
            
            // Top users table
            if (data.topUsers && data.topUsers.length > 0) {
                html += '<h4>Top 20 Most Active Trial Users</h4>';
                html += '<table><thead><tr>';
                html += '<th>ID</th><th>Email</th><th>Name</th><th>Specialty</th>';
                html += '<th>Validations</th><th>Max Allowed</th><th>% Used</th>';
                html += '<th>Created</th><th>Last Activity</th>';
                html += '</tr></thead><tbody>';
                
                data.topUsers.forEach(user => {
                    const percentUsed = ((user.validation_count / user.max_validations) * 100).toFixed(1);
                    html += '<tr>';
                    html += `<td>${user.id}</td>`;
                    html += `<td>${user.email}</td>`;
                    html += `<td>${user.first_name || ''} ${user.last_name || ''}</td>`;
                    html += `<td>${user.specialty || 'N/A'}</td>`;
                    html += `<td><strong>${user.validation_count}</strong></td>`;
                    html += `<td>${user.max_validations}</td>`;
                    html += `<td>${percentUsed}%</td>`;
                    html += `<td>${new Date(user.created_at).toLocaleDateString()}</td>`;
                    html += `<td>${user.last_validation_at ? new Date(user.last_validation_at).toLocaleDateString() : 'Never'}</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            resultsDiv.innerHTML = html;
        }

        function displayPhysicianStats(data) {
            const resultsDiv = document.getElementById('results');
            let html = '<h3>Physician Order Statistics</h3>';
            
            // Physician info
            html += '<div class="info">';
            html += '<h4>Physician Information</h4>';
            const physician = data.physician;
            html += `<p>Name: <strong>${physician.first_name} ${physician.last_name}</strong></p>`;
            html += `<p>Email: <strong>${physician.email}</strong></p>`;
            html += `<p>Role: <strong>${physician.role}</strong></p>`;
            html += `<p>Organization ID: <strong>${physician.organization_id}</strong></p>`;
            html += '</div>';
            
            // Statistics
            html += '<div class="info">';
            html += '<h4>Order Statistics</h4>';
            const stats = data.statistics;
            html += `<p>Total Orders: <strong>${stats.total_orders}</strong></p>`;
            html += `<p>Completed Orders: <strong>${stats.completed_orders}</strong></p>`;
            html += `<p>Overridden Orders: <strong>${stats.overridden_orders}</strong></p>`;
            html += `<p>Appropriate Orders: <strong>${stats.appropriate_orders}</strong></p>`;
            html += `<p>Inappropriate Orders: <strong>${stats.inappropriate_orders}</strong></p>`;
            html += `<p>Average Compliance Score: <strong>${stats.avg_compliance_score ? parseFloat(stats.avg_compliance_score).toFixed(1) : 'N/A'}</strong></p>`;
            html += '</div>';
            
            // Recent orders
            if (data.recentOrders && data.recentOrders.length > 0) {
                html += '<h4>Recent Orders</h4>';
                html += '<table><thead><tr>';
                html += '<th>ID</th><th>Order Number</th><th>Status</th><th>Patient</th>';
                html += '<th>Modality</th><th>Body Part</th><th>Validation</th><th>Score</th>';
                html += '<th>Overridden</th><th>Created</th>';
                html += '</tr></thead><tbody>';
                
                data.recentOrders.forEach(order => {
                    html += '<tr>';
                    html += `<td>${order.id}</td>`;
                    html += `<td>${order.order_number}</td>`;
                    html += `<td>${order.status}</td>`;
                    html += `<td>${order.patient_name || 'N/A'}</td>`;
                    html += `<td>${order.modality || 'N/A'}</td>`;
                    html += `<td>${order.body_part || 'N/A'}</td>`;
                    html += `<td>${order.final_validation_status || 'N/A'}</td>`;
                    html += `<td>${order.final_compliance_score || 'N/A'}</td>`;
                    html += `<td>${order.overridden ? 'Yes' : 'No'}</td>`;
                    html += `<td>${new Date(order.created_at).toLocaleDateString()}</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            resultsDiv.innerHTML = html;
        }

        function displayTrialUserActivity(data) {
            const resultsDiv = document.getElementById('results');
            let html = '<h3>Trial User Activity Details</h3>';
            
            // User info
            html += '<div class="info">';
            html += '<h4>User Information</h4>';
            const user = data.user;
            html += `<p>Email: <strong>${user.email}</strong></p>`;
            html += `<p>Name: <strong>${user.first_name || ''} ${user.last_name || ''}</strong></p>`;
            html += `<p>Validations Used: <strong>${user.validation_count} / ${user.max_validations}</strong></p>`;
            html += `<p>Created: <strong>${new Date(user.created_at).toLocaleDateString()}</strong></p>`;
            html += '</div>';
            
            // Daily activity
            if (data.dailyActivity && data.dailyActivity.length > 0) {
                html += '<h4>Daily Activity</h4>';
                html += '<table><thead><tr>';
                html += '<th>Date</th><th>Validations</th><th>Avg Latency (ms)</th><th>Tokens Used</th>';
                html += '</tr></thead><tbody>';
                
                data.dailyActivity.forEach(day => {
                    html += '<tr>';
                    html += `<td>${day.date}</td>`;
                    html += `<td>${day.validations}</td>`;
                    html += `<td>${parseFloat(day.avg_latency).toFixed(0)}</td>`;
                    html += `<td>${day.tokens_used}</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            resultsDiv.innerHTML = html;
        }

        function displayCompleteOrderDetails(data) {
            const resultsDiv = document.getElementById('results');
            let html = '<h3>Complete Order Details</h3>';
            
            // Order info
            html += '<div class="info">';
            html += '<h4>Order Information</h4>';
            html += `<pre>${JSON.stringify(data.order, null, 2)}</pre>`;
            html += '</div>';
            
            // Patient info
            if (data.patient) {
                html += '<div class="info">';
                html += '<h4>Patient Information</h4>';
                html += `<pre>${JSON.stringify(data.patient, null, 2)}</pre>`;
                html += '</div>';
            }
            
            // Insurance info
            if (data.insurance && data.insurance.length > 0) {
                html += '<div class="info">';
                html += '<h4>Insurance Information</h4>';
                data.insurance.forEach((ins, index) => {
                    html += `<h5>${ins.is_primary ? 'Primary' : 'Secondary'} Insurance</h5>`;
                    html += `<pre>${JSON.stringify(ins, null, 2)}</pre>`;
                });
                html += '</div>';
            }
            
            // Clinical records
            if (data.clinicalRecords && data.clinicalRecords.length > 0) {
                html += '<h4>Clinical Records</h4>';
                html += '<table><thead><tr>';
                html += '<th>ID</th><th>Type</th><th>Content (Preview)</th><th>Added By</th><th>Added At</th>';
                html += '</tr></thead><tbody>';
                
                data.clinicalRecords.forEach(record => {
                    html += '<tr>';
                    html += `<td>${record.id}</td>`;
                    html += `<td>${record.record_type}</td>`;
                    html += `<td>${(record.content || '').substring(0, 100)}...</td>`;
                    html += `<td>${record.added_by_user_id}</td>`;
                    html += `<td>${new Date(record.added_at).toLocaleString()}</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            resultsDiv.innerHTML = html;
        }

        function displayOrganizationConnections(data) {
            const resultsDiv = document.getElementById('results');
            let html = '<h3>Organization Connections</h3>';
            html += `<p>Organization ID: <strong>${data.organizationId}</strong></p>`;
            
            if (data.connections && data.connections.length > 0) {
                html += '<h4>Connected Radiology Organizations</h4>';
                
                data.connections.forEach(conn => {
                    html += '<div class="info">';
                    html += `<h5>${conn.organizationName} (${conn.organizationType})</h5>`;
                    html += `<p>Organization ID: ${conn.organizationId}</p>`;
                    
                    if (conn.locations && conn.locations.length > 0) {
                        html += '<p><strong>Locations:</strong></p>';
                        html += '<ul>';
                        conn.locations.forEach(loc => {
                            html += `<li>ID: ${loc.locationId} - ${loc.locationName}</li>`;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p><em>No locations configured</em></p>';
                    }
                    html += '</div>';
                });
            } else {
                html += '<div class="info">No active connections found for this organization</div>';
            }
            
            resultsDiv.innerHTML = html;
        }

        function displayUpdateHistory(data) {
            const resultsDiv = document.getElementById('results');
            let html = '<h3>Order Update History</h3>';
            html += `<p>Order ID: <strong>${data.orderId}</strong></p>`;
            
            if (data.updateHistory && data.updateHistory.length > 0) {
                html += '<table><thead><tr>';
                html += '<th>Table</th><th>Action</th><th>Timestamp</th>';
                html += '</tr></thead><tbody>';
                
                data.updateHistory.forEach(update => {
                    html += '<tr>';
                    html += `<td>${update.table_name}</td>`;
                    html += `<td>${update.action}</td>`;
                    html += `<td>${new Date(update.timestamp).toLocaleString()}</td>`;
                    html += '</tr>';
                });
                html += '</tbody></table>';
            } else {
                html += '<div class="info">No update history found</div>';
            }
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>