# Server-Side Fix Guide for S3 Upload Signature Issue

## Problem Summary
The S3 presigned URL signature calculation is failing with "SignatureDoesNotMatch" error. The AWS credentials are correct, but the signature generated by the server doesn't match what S3 expects.

## Common Causes & Solutions

### 1. Clock Skew Issue (Most Common)
S3 requires the server time to be within 15 minutes of AWS time.

**Check server time:**
```bash
# On the server, run:
date
# Compare with AWS time:
curl -I https://s3.amazonaws.com 2>&1 | grep -i date
```

**Fix if times differ by more than 5 minutes:**
```bash
# Install NTP if not already installed
sudo apt-get update && sudo apt-get install ntp -y
# Or on Amazon Linux:
sudo yum install ntp -y

# Sync time
sudo ntpdate -s time.nist.gov
sudo service ntp restart
```

### 2. AWS SDK Version Issue
Older AWS SDK versions may have signature calculation bugs.

**Check current version in package.json:**
```json
"@aws-sdk/client-s3": "^3.x.x"
```

**Update to latest:**
```bash
npm update @aws-sdk/client-s3 @aws-sdk/s3-request-presigner
```

### 3. Environment Variable Issues
Ensure the server is loading the correct AWS credentials.

**Add debug logging to your presigned URL generation code:**
```javascript
// In your server code where presigned URLs are generated
console.log('AWS Config Check:', {
  region: process.env.AWS_REGION,
  accessKeyId: process.env.AWS_ACCESS_KEY_ID?.substring(0, 10) + '...',
  bucket: process.env.S3_BUCKET_NAME,
  nodeEnv: process.env.NODE_ENV
});
```

### 4. URL Encoding Issues
The presigned URL might be getting double-encoded.

**Check your presigned URL generation code:**
```javascript
// Example of correct implementation
const { S3Client } = require('@aws-sdk/client-s3');
const { getSignedUrl } = require('@aws-sdk/s3-request-presigner');
const { PutObjectCommand } = require('@aws-sdk/client-s3');

const s3Client = new S3Client({
  region: process.env.AWS_REGION,
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY
  }
});

async function generatePresignedUrl(key, contentType) {
  const command = new PutObjectCommand({
    Bucket: process.env.S3_BUCKET_NAME,
    Key: key,
    ContentType: contentType,
    ACL: 'private'
  });
  
  // Don't encode the URL - let the SDK handle it
  const url = await getSignedUrl(s3Client, command, { 
    expiresIn: 3600 
  });
  
  return url;
}
```

### 5. Secret Key Mismatch
Verify the secret key matches exactly.

**On the server, create a test script:**
```javascript
// test-s3-credentials.js
const { S3Client, ListBucketsCommand } = require('@aws-sdk/client-s3');

const s3Client = new S3Client({
  region: process.env.AWS_REGION,
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY
  }
});

async function testCredentials() {
  try {
    const command = new ListBucketsCommand({});
    const response = await s3Client.send(command);
    console.log('✅ AWS credentials are valid');
    console.log('Buckets:', response.Buckets.map(b => b.Name));
  } catch (error) {
    console.error('❌ AWS credentials error:', error.message);
  }
}

testCredentials();
```

Run it:
```bash
node test-s3-credentials.js
```

## Quick Diagnostic Steps

1. **SSH into your server**
2. **Check the time:**
   ```bash
   date && curl -I https://s3.amazonaws.com 2>&1 | grep -i date
   ```

3. **Check environment variables:**
   ```bash
   echo "Region: $AWS_REGION"
   echo "Access Key: ${AWS_ACCESS_KEY_ID:0:10}..."
   echo "Bucket: $S3_BUCKET_NAME"
   ```

4. **Test S3 access directly:**
   ```bash
   aws s3 ls s3://$S3_BUCKET_NAME --region $AWS_REGION
   ```

5. **Check Node.js and AWS SDK versions:**
   ```bash
   node --version
   npm list @aws-sdk/client-s3
   ```

## Recommended Fix Order

1. **Fix time sync** (takes 2 minutes, fixes 80% of signature issues)
2. **Update AWS SDK** (takes 5 minutes, fixes compatibility issues)
3. **Verify credentials** (takes 2 minutes, confirms setup)
4. **Check code implementation** (takes 10-20 minutes if changes needed)

## Testing After Fix

After applying fixes, test with:
```bash
# From your local machine
cd all-backend-tests
admin-staff-role-comprehensive-tests.bat
```

The file upload test should now show:
- Status: 200 (instead of 403)
- Successful upload confirmation

## Additional Debugging

If still failing, add detailed logging to your server's presigned URL endpoint:
```javascript
app.post('/api/uploads/presigned-url', async (req, res) => {
  console.log('Presigned URL request:', {
    timestamp: new Date().toISOString(),
    body: req.body,
    headers: req.headers
  });
  
  // Your existing code...
  
  console.log('Generated presigned URL:', {
    url: presignedUrl.substring(0, 100) + '...',
    expires: expiresIn,
    key: fileKey
  });
});
```

This will help identify any request/response issues.